<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lumina Studio â€” Ù…Ø­Ø±Ø± Ø§Ù„ØªØ¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø­ØªØ±Ù</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&family=IBM+Plex+Sans+Arabic:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    /* ---------- Design System ---------- */
    :root {
      --font-arabic: 'Cairo', 'IBM Plex Sans Arabic', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', Consolas, monospace;

      /* Dark Theme (Default) */
      --bg-page: #09090b;
      --bg-panel: #18181b;
      --bg-surface: #27272a;
      
      --border-subtle: rgba(255,255,255,0.08);
      --border-focus: rgba(255,255,255,0.2);
      
      --text-main: #fafafa;
      --text-muted: #a1a1aa;
      --text-dim: #52525b;

      --primary: #6366f1;
      --primary-glow: rgba(99, 102, 241, 0.4);
      --accent: #ec4899;

      --radius-xl: 20px;
      --radius-lg: 12px;
      --radius-md: 8px;
      
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
      --shadow-lg: 0 20px 50px -12px rgba(0,0,0,0.5);
    }

    /* Light Theme Overrides */
    [data-theme="light"] {
      --bg-page: #f4f4f5;
      --bg-panel: #ffffff;
      --bg-surface: #f3f4f6;
      --border-subtle: rgba(0,0,0,0.08);
      --border-focus: rgba(0,0,0,0.2);
      --text-main: #18181b;
      --text-muted: #71717a;
      --text-dim: #d4d4d8;
      --shadow-lg: 0 20px 40px -12px rgba(0,0,0,0.1);
    }

    /* RTL Support for Arabic - Improved */
    [dir="rtl"] {
      font-family: var(--font-arabic);
    }
    
    [dir="rtl"] .brand { flex-direction: row-reverse; }
    [dir="rtl"] .row { flex-direction: row-reverse; }
    [dir="rtl"] .spread { flex-direction: row-reverse; }
    [dir="rtl"] .toolbar .row { flex-direction: row-reverse; }
    [dir="rtl"] .dropdown-menu { right: auto; left: 0; }
    [dir="rtl"] .code-floater { text-align: right; }
    [dir="rtl"] .sidebar-content { padding-left: 4px; padding-right: 0; }
    [dir="rtl"] .steps-strip { direction: ltr; } /* Keep gradient direction consistent */
    [dir="rtl"] .lang-dropdown-menu { right: auto; left: 0; }
    [dir="rtl"] .hex-input { direction: ltr; text-align: left; }
    [dir="rtl"] input[type="text"], 
    [dir="rtl"] input[type="email"], 
    [dir="rtl"] input[type="password"], 
    [dir="rtl"] select {
      text-align: right;
    }
    [dir="rtl"] .step-btn { transform: scaleX(-1); }
    [dir="rtl"] .color-row:hover { transform: translateX(-2px); }
    [dir="rtl"] .modal-header { flex-direction: row-reverse; }
    [dir="rtl"] .preset-info { text-align: right; }
    [dir="rtl"] .btn { flex-direction: row-reverse; }
    [dir="rtl"] .muted { text-align: right; }

    /* Arabic Typography Improvements */
    .arabic-text {
      font-family: var(--font-arabic);
      line-height: 1.8;
    }
    
    .arabic-text h1, 
    .arabic-text h2, 
    .arabic-text h3, 
    .arabic-text h4 {
      font-weight: 600;
    }
    
    .arabic-text p {
      margin-bottom: 1rem;
    }

    /* Prevent body scroll when modal is open */
    body.modal-open {
      overflow: hidden;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    
    body {
      background: var(--bg-page);
      color: var(--text-main);
      font-family: var(--font-sans);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* Background Ambience */
    .ambience { position: fixed; inset: 0; z-index: -1; overflow: hidden; pointer-events: none; }
    .orb { position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.15; animation: float 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1); }
    .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--primary); }
    .orb-2 { bottom: -10%; right: -10%; width: 40vw; height: 40vw; background: var(--accent); animation-delay: -5s; }
    @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(50px, 30px); } }

    /* Layout & Grid */
    .app-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      width: 100%;
      flex: 1;
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 24px;
      height: 100vh;
      max-height: 100vh;
    }

    @media (max-width: 1024px) {
      .app-container { grid-template-columns: 1fr; height: auto; max-height: none; }
    }

    /* Panels */
    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      box-shadow: var(--shadow-sm);
    }

    /* Typography */
    h2 { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; margin-bottom: 8px; }
    label { font-size: 0.85rem; color: var(--text-muted); display: block; margin-bottom: 6px; font-weight: 500; }
    
    /* Header/Nav */
    header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 20px; border-bottom: 1px solid var(--border-subtle); margin-bottom: 4px; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .logo-box { width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 14px; }
    .brand h1 { font-size: 16px; font-weight: 700; }
    
    /* Language Toggle Button */
    .lang-toggle {
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
      padding: 4px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      margin-left: 8px;
      transition: all 0.2s;
    }
    .lang-toggle:hover {
      background: var(--bg-surface);
      color: var(--text-main);
    }
    
    /* Language Dropdown */
    .lang-dropdown-container {
      position: relative;
      display: inline-block;
    }
    
    .lang-dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      width: 180px;
      background: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 6px;
      box-shadow: var(--shadow-lg);
      display: none;
      z-index: 150;
    }
    
    .lang-dropdown-menu.show {
      display: block;
      animation: fadeIn 0.15s ease;
    }
    
    .lang-option {
      display: block;
      width: 100%;
      text-align: right;
      padding: 8px 12px;
      background: transparent;
      border: none;
      color: var(--text-main);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-family: var(--font-sans);
    }
    
    [dir="rtl"] .lang-option {
      text-align: right;
      font-family: var(--font-arabic);
    }
    
    .lang-option:hover {
      background: var(--bg-surface);
    }
    
    .lang-option.active {
      background: var(--primary);
      color: white;
    }

    /* User Account Button */
    .user-account-btn {
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      margin-left: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    [dir="rtl"] .user-account-btn {
      margin-left: 0;
      margin-right: 8px;
    }
    
    .user-account-btn:hover {
      background: var(--bg-surface);
      color: var(--text-main);
    }
    
    .user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }
    
    .user-name {
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 0 16px; height: 36px;
      border-radius: var(--radius-md);
      font-size: 0.85rem; font-weight: 500;
      cursor: pointer; transition: all 0.2s;
      border: 1px solid transparent;
      font-family: var(--font-sans);
    }
    
    [dir="rtl"] .btn {
      font-family: var(--font-arabic);
    }
    
    .btn-primary {
      background: var(--text-main); color: var(--bg-page);
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255,255,255,0.15); }
    
    .btn-ghost {
      background: transparent; border: 1px solid var(--border-subtle); color: var(--text-main);
    }
    .btn-ghost:hover { border-color: var(--text-muted); background: var(--bg-surface); }
    
    .btn-icon { padding: 0; width: 32px; height: 32px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; }
    .btn-icon:hover { background: var(--bg-surface); color: var(--text-main); }

    /* Inputs */
    input[type="text"], input[type="email"], input[type="password"], select {
      width: 100%; height: 36px; padding: 0 12px;
      background: var(--bg-surface); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md); color: var(--text-main);
      font-family: var(--font-sans); font-size: 0.9rem;
      transition: border 0.2s;
    }
    
    [dir="rtl"] input[type="text"], 
    [dir="rtl"] input[type="email"], 
    [dir="rtl"] input[type="password"], 
    [dir="rtl"] select {
      font-family: var(--font-arabic);
    }
    
    input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, select:focus { border-color: var(--primary); }
    
    .hex-input { font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 0.5px; }

    /* Custom Range Slider */
    input[type=range] {
      -webkit-appearance: none; width: 100%; background: transparent; margin: 10px 0;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
      background: var(--text-main); cursor: pointer; margin-top: -6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 4px; cursor: pointer; background: var(--bg-surface); border-radius: 2px; border: 1px solid var(--border-subtle);
    }

    /* Steps controls with buttons */
    .steps-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }
    
    .step-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .step-btn:hover {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .step-btn:active {
      transform: scale(0.95);
    }
    
    .steps-slider-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* Scrollable Sidebar */
    .sidebar-content { overflow-y: auto; padding-right: 4px; display: flex; flex-direction: column; gap: 24px; max-height: calc(100vh - 120px); }
    
    /* Color List */
    .color-stack { display: flex; flex-direction: column; gap: 8px; }
    .color-row {
      display: flex; align-items: center; gap: 10px;
      background: var(--bg-surface); padding: 6px; border-radius: var(--radius-md);
      border: 1px solid transparent; transition: all 0.2s;
    }
    .color-row:hover { border-color: var(--border-subtle); transform: translateX(2px); }
    
    [dir="rtl"] .color-row:hover { transform: translateX(-2px); }
    
    .color-preview {
      width: 36px; height: 36px; border-radius: 6px;
      position: relative; overflow: hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    .color-picker-trigger { position: absolute; inset: -4px; width: 150%; height: 150%; opacity: 0; cursor: pointer; }

    /* Base Color Preview FIX */
    .base-color-preview {
      width: 40px;
      height: 36px;
      border-radius: 6px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    .base-color-picker-trigger {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    /* Main Preview Area - Changed to strips */
    .preview-section {
      display: flex; flex-direction: column; gap: 16px; height: 100%;
    }
    
    .toolbar { display: flex; justify-content: space-between; align-items: center; }

    .canvas-wrapper {
      flex: 1;
      background-color: var(--bg-surface);
      /* Checkerboard pattern for transparency */
      background-image:
        linear-gradient(45deg, #1f1f22 25%, transparent 25%),
        linear-gradient(-45deg, #1f1f22 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #1f1f22 75%),
        linear-gradient(-45deg, transparent 75%, #1f1f22 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      position: relative;
      overflow: hidden;
      min-height: 400px;
      box-shadow: inset 0 0 40px rgba(0,0,0,0.2);
    }
    [data-theme="light"] .canvas-wrapper {
      background-image:
        linear-gradient(45deg, #e4e4e7 25%, transparent 25%),
        linear-gradient(-45deg, #e4e4e7 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #e4e4e7 75%),
        linear-gradient(-45deg, transparent 75%, #e4e4e7 75%);
    }

    #previewBox { 
      width: 100%; 
      height: 100%; 
      display: flex;
      flex-direction: row;
      transition: background 0.1s linear;
    }
    
    .preview-strip {
      flex: 1;
      height: 100%;
      transition: background-color 0.1s ease;
      position: relative;
    }
    
    .preview-strip:hover::after {
      content: attr(data-color);
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-family: var(--font-mono);
      z-index: 10;
    }

    .code-floater {
      position: absolute; bottom: 20px; left: 20px; right: 20px;
      background: rgba(15, 15, 17, 0.85); backdrop-filter: blur(12px);
      padding: 12px 16px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex; justify-content: space-between; align-items: center;
      color: var(--text-main); font-family: var(--font-mono); font-size: 0.85rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      cursor: pointer; transition: transform 0.2s;
    }
    .code-floater:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.2); }
    
    /* Steps/Breakdown Strip */
    .steps-strip {
      height: 48px;
      display: flex;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border-subtle);
      cursor: crosshair;
    }
    .step-unit { flex: 1; transition: opacity 0.1s; }
    .step-unit:hover { opacity: 0.8; }

    /* Modals */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
      z-index: 100; display: none; align-items: center; justify-content: center;
      opacity: 0; transition: opacity 0.2s;
    }
    .modal-overlay.active { display: flex; opacity: 1; }
    
    .modal-card {
      background: var(--bg-panel); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl); width: 90%; max-width: 900px;
      max-height: 85vh; overflow: hidden; display: flex; flex-direction: column;
      box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform 0.2s;
    }
    .modal-overlay.active .modal-card { transform: scale(1); }
    
    .modal-header { padding: 20px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 20px; overflow-y: auto; }
    
    .preset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
    .preset-item {
      border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); overflow: hidden;
      cursor: pointer; transition: transform 0.2s, border-color 0.2s; background: var(--bg-surface);
    }
    .preset-item:hover { transform: translateY(-4px); border-color: var(--text-muted); }
    .preset-preview { 
      height: 100px; 
      width: 100%; 
      display: flex;
      flex-direction: row;
    }
    .preset-strip {
      flex: 1;
      height: 100%;
    }
    .preset-info { padding: 12px; font-weight: 500; font-size: 0.9rem; }
    
    /* User Gradients Section */
    .user-gradients-section {
      margin-top: 24px;
    }
    
    .user-gradients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    
    .save-gradient-btn {
      margin-top: 12px;
      width: 100%;
    }
    
    /* Login Form Styles */
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .auth-form-header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    [dir="rtl"] .auth-form-header {
      text-align: center;
    }
    
    .auth-form-header h3 {
      font-size: 1.2rem;
      margin-bottom: 8px;
    }
    
    .auth-form-header p {
      color: var(--text-muted);
      font-size: 0.85rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }
    
    .auth-divider {
      display: flex;
      align-items: center;
      margin: 16px 0;
      color: var(--text-muted);
      font-size: 0.8rem;
    }
    
    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-subtle);
    }
    
    .auth-divider span {
      padding: 0 12px;
    }
    
    .google-signin-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .google-signin-btn:hover {
      background: var(--bg-panel);
      border-color: var(--primary);
    }
    
    .google-icon {
      width: 18px;
      height: 18px;
    }
    
    .auth-switch {
      text-align: center;
      margin-top: 16px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }
    
    [dir="rtl"] .auth-switch {
      text-align: center;
    }
    
    .auth-switch a {
      color: var(--primary);
      cursor: pointer;
      text-decoration: none;
    }
    
    .auth-switch a:hover {
      text-decoration: underline;
    }
    
    .auth-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: #ef4444;
      padding: 12px;
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      display: none;
      text-align: center;
    }
    
    [dir="rtl"] .auth-error {
      text-align: center;
    }
    
    .auth-error.show {
      display: block;
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-subtle);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast */
    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: var(--text-main); color: var(--bg-page);
      padding: 10px 24px; border-radius: 50px; font-weight: 600;
      opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      pointer-events: none; z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* Utility */
    .control-group { background: var(--bg-surface); padding: 16px; border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); }
    .row { display: flex; gap: 10px; align-items: center; }
    .spread { display: flex; justify-content: space-between; align-items: center; }
    .muted { color: var(--text-muted); font-size: 0.8rem; }
    
    /* Toggle Switch */
    .toggle { appearance: none; width: 40px; height: 22px; background: var(--bg-panel); border: 1px solid var(--border-subtle); border-radius: 20px; position: relative; cursor: pointer; transition: 0.3s; }
    .toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: var(--text-muted); border-radius: 50%; transition: 0.3s; }
    .toggle:checked { background: var(--primary); border-color: var(--primary); }
    .toggle:checked::after { transform: translateX(18px); background: #fff; }
    
    [dir="rtl"] .toggle::after { left: auto; right: 2px; }
    [dir="rtl"] .toggle:checked::after { transform: translateX(-18px); }

    /* Dropdown Menu */
    .dropdown-container { position: relative; }
    .dropdown-menu {
      position: absolute; top: 100%; right: 0; margin-top: 8px; width: 200px;
      background: var(--bg-panel); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg); padding: 6px; box-shadow: var(--shadow-lg);
      display: none; z-index: 50;
    }
    .dropdown-menu.show { display: block; animation: fadeIn 0.15s ease; }
    .menu-item {
      display: block; width: 100%; text-align: left; padding: 8px 12px;
      background: transparent; border: none; color: var(--text-main);
      border-radius: 6px; cursor: pointer; font-size: 0.9rem;
    }
    
    [dir="rtl"] .menu-item {
      text-align: right;
    }
    
    .menu-item:hover { background: var(--bg-surface); }
    
    @keyframes fadeIn { from{opacity:0;transform:translateY(-5px)} to{opacity:1;transform:translateY(0)} }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body data-theme="dark" dir="rtl">

  <div class="ambience">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
  </div>

  <main class="app-container">
    
    <aside class="panel">
      <header>
        <div class="brand">
          <div class="logo-box">LS</div>
          <h1 data-i18n="appTitle">Lumina Studio</h1>
        </div>
        <div style="display: flex; gap: 8px;">
          <div class="lang-dropdown-container">
            <button id="langToggle" class="lang-toggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©">ğŸŒ AR</button>
            <div id="langDropdown" class="lang-dropdown-menu">
              <button data-lang="ar" class="lang-option active">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
              <button data-lang="en" class="lang-option">ğŸ‡ºğŸ‡¸ English</button>
              <button data-lang="fr" class="lang-option">ğŸ‡«ğŸ‡· FranÃ§ais</button>
              <button data-lang="es" class="lang-option">ğŸ‡ªğŸ‡¸ EspaÃ±ol</button>
              <button data-lang="de" class="lang-option">ğŸ‡©ğŸ‡ª Deutsch</button>
              <button data-lang="zh" class="lang-option">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
              <button data-lang="ja" class="lang-option">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
              <button data-lang="ru" class="lang-option">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</button>
              <button data-lang="tr" class="lang-option">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</button>
              <button data-lang="pt" class="lang-option">ğŸ‡µğŸ‡¹ PortuguÃªs</button>
              <button data-lang="hi" class="lang-option">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</button>
              <button data-lang="ko" class="lang-option">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
              <button data-lang="it" class="lang-option">ğŸ‡®ğŸ‡¹ Italiano</button>
            </div>
          </div>
          <button id="userAccountBtn" class="user-account-btn" title="Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
            <span class="user-name" id="userName" data-i18n="signIn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
          </button>
          <button id="themeToggle" class="btn-icon" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù…Ø©">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
          </button>
        </div>
      </header>

      <div class="sidebar-content arabic-text">
        <section>
          <div class="spread" style="margin-bottom:8px">
            <h2 data-i18n="smartGenerator">Ù…ÙˆÙ„Ø¯ Ø§Ù„ØªÙ†Ø§ØºÙ…</h2>
          </div>
          <div class="control-group">
            <label data-i18n="baseColor">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
            <div class="row" style="margin-bottom:12px">
              <div class="base-color-preview" id="baseColorPreview" style="background-color: #6366F1;">
                <input id="genBaseColor" type="color" value="#6366f1" class="base-color-picker-trigger">
              </div>
              <input id="genBaseHex" type="text" value="#6366F1" class="hex-input">
            </div>
            
            <label data-i18n="harmonyMode">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù†</label>
            <select id="genMode" style="margin-bottom:12px">
              <option value="random" data-i18n="randomCount">Ø¹Ø´ÙˆØ§Ø¦ÙŠ (2-5)</option>
              <option value="2" data-i18n="twoColors">Ù„ÙˆÙ†ÙŠÙ†</option>
              <option value="3" selected data-i18n="threeColors">3 Ø£Ù„ÙˆØ§Ù†</option>
              <option value="4" data-i18n="fourColors">4 Ø£Ù„ÙˆØ§Ù†</option>
              <option value="5" data-i18n="fiveColors">5 Ø£Ù„ÙˆØ§Ù†</option>
            </select>
            
            <label style="margin-top:12px" data-i18n="basePosition">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
            <select id="basePosition" style="margin-bottom:12px">
              <option value="start" selected data-i18n="atStart">ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</option>
              <option value="end" data-i18n="atEnd">ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</option>
              <option value="middle" data-i18n="inMiddle">ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ</option>
              <option value="random" data-i18n="randomPosition">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
            </select>
            
            <button id="btnSmartGenerate" class="btn btn-primary" style="width:100%" data-i18n="generatePalette">Ø¥Ù†Ø´Ø§Ø¡ ØªÙ†Ø§ØºÙ… Ø¬Ø¯ÙŠØ¯</button>
          </div>
        </section>

        <section>
          <div class="spread" style="margin-bottom:8px">
            <h2 data-i18n="colorStops">Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ù„ÙˆØ§Ù†</h2>
            <div style="display:flex; gap:8px">
               <button id="btnRandom" class="btn-icon" title="Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙƒÙ„ÙŠ" data-i18n-title="randomize">ğŸ²</button>
               <button id="btnAddColor" class="btn-icon" title="Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø©" data-i18n-title="addStop">â•</button>
            </div>
          </div>
          
          <div id="colorList" class="color-stack">
            </div>
        </section>

        <section>
           <h2 data-i18n="configuration">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
           <div class="control-group">
             <div class="spread">
               <label data-i18n="stepsPrecision">Ø§Ù„Ø®Ø·ÙˆØ§Øª / Ø§Ù„Ø¯Ù‚Ø©</label>
               <span id="stepsVal" class="muted font-mono">15</span>
             </div>
             
             <div class="steps-controls">
               <button id="stepsDecrease" class="step-btn">âˆ’</button>
               <div class="steps-slider-container">
                 <input id="stepsInput" type="range" min="2" max="100" value="15">
               </div>
               <button id="stepsIncrease" class="step-btn">+</button>
             </div>

             <div class="spread" style="margin-top:16px">
               <label for="checkVivid" style="margin:0; cursor:pointer" data-i18n="vividMode">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­ÙŠÙˆÙŠ (LAB)</label>
               <input id="checkVivid" type="checkbox" class="toggle">
             </div>
             <p class="muted" style="margin-top:8px; font-size:0.75rem; line-height:1.4" data-i18n="vividDescription">Ø§Ø³ØªÙŠÙØ§Ø¡ Ù…ÙˆØ­Ø¯ Ø¥Ø¯Ø±Ø§ÙƒÙŠØ§Ù‹ ÙŠÙ…Ù†Ø¹ 'Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ© Ø§Ù„Ù…ÙŠØªØ©' ÙÙŠ Ø§Ù„ØªØ¯Ø±Ø¬Ø§Øª.</p>
           </div>
        </section>
      </div>
    </aside>

    <section class="preview-section">
      <div class="toolbar">
        <div class="row">
          <button id="openPresetsBtn" class="btn btn-ghost" data-i18n="gallery">Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
          <button id="openBreakdownBtn" class="btn btn-ghost" data-i18n="analyze">ØªØ­Ù„ÙŠÙ„</button>
          <button id="saveGradientBtn" class="btn btn-ghost" data-i18n="saveGradient">Ø­ÙØ¸ Ø§Ù„ØªØ¯Ø±Ø¬</button>
        </div>
        
        <div class="dropdown-container">
          <button id="btnExportToggle" class="btn btn-primary" data-i18n="downloadExport">ØªÙ†Ø²ÙŠÙ„ / ØªØµØ¯ÙŠØ±</button>
          <div id="exportMenu" class="dropdown-menu">
             <button id="actCopyCSS" class="menu-item" data-i18n="copyCSS">ğŸ“‹ Ù†Ø³Ø® CSS</button>
             <button id="actCopyTailwind" class="menu-item" data-i18n="copyTailwind">ğŸ’¨ Ù†Ø³Ø® Tailwind</button>
             <hr style="border:0; border-top:1px solid var(--border-subtle); margin:4px 0">
             <button id="actDownloadCSS" class="menu-item" data-i18n="downloadCSS">ğŸ“„ ØªÙ†Ø²ÙŠÙ„ .CSS</button>
             <button id="actDownloadPNG" class="menu-item" data-i18n="downloadPNG">ğŸ–¼ï¸ ØªÙ†Ø²ÙŠÙ„ .PNG</button>
          </div>
        </div>
      </div>

      <div class="canvas-wrapper">
        <div id="previewBox" role="img" aria-label="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ¯Ø±Ø¬"></div>
        <div class="code-floater" id="cssPreviewTrigger" title="Ø§Ù†Ù‚Ø± Ù„Ù„Ù†Ø³Ø®" data-i18n-title="clickToCopy">
          <span id="cssPreviewText" style="opacity:0.8">linear-gradient(...)</span>
          <span style="opacity:0.5; font-size:0.75rem; margin-left:12px" data-i18n="clickToCopy">Ø§Ù†Ù‚Ø± Ù„Ù„Ù†Ø³Ø®</span>
        </div>
      </div>

      <div>
        <div class="spread" style="margin-bottom:8px">
          <h2 data-i18n="gradientSpectrum">Ø·ÙŠÙ Ø§Ù„ØªØ¯Ø±Ø¬</h2>
          <span class="muted" style="font-size:0.75rem" data-i18n="spectrumHint">Ù…Ø±Ø± Ù„Ù„ØªØ­Ø¯ÙŠØ¯ØŒ Ø§Ù†Ù‚Ø± Ù„Ù„Ù†Ø³Ø®</span>
        </div>
        <div id="stepsGrid" class="steps-strip"></div>
      </div>
    </section>

  </main>

  <div id="presetsModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <h3 data-i18n="gradientGallery">Ù…Ø¹Ø±Ø¶ Ø§Ù„ØªØ¯Ø±Ø¬Ø§Øª</h3>
        <button class="btn-icon close-modal">âœ•</button>
      </div>
      <div class="modal-body">
        <h4 style="margin-bottom: 12px;" data-i18n="builtinGradients">Ø§Ù„ØªØ¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù†Ø©</h4>
        <div id="presetsGrid" class="preset-grid"></div>
        
        <div class="user-gradients-section">
          <div class="spread">
            <h4 style="margin-bottom: 12px;" data-i18n="mySavedGradients">ØªØ¯Ø±Ø¬Ø§ØªÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h4>
            <button id="clearSavedGradients" class="btn btn-ghost btn-small" style="font-size: 0.75rem;" data-i18n="clearAll">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
          </div>
          <div id="userGradientsGrid" class="user-gradients-grid">
            <!-- User saved gradients will appear here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="breakdownModal" class="modal-overlay">
    <div class="modal-card" style="max-width:600px">
      <div class="modal-header">
        <h3 data-i18n="colorAnalysis">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù†</h3>
        <button class="btn-icon close-breakdown">âœ•</button>
      </div>
      <div class="modal-body">
        <div id="breakGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(60px,1fr)); gap:8px"></div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="modal-overlay">
    <div class="modal-card" style="max-width: 400px;">
      <div class="modal-header">
        <h3 id="authModalTitle" data-i18n="signIn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <button class="btn-icon close-auth-modal">âœ•</button>
      </div>
      <div class="modal-body arabic-text">
        <div class="auth-error" id="authError"></div>
        
        <div class="auth-form" id="signInForm">
          <div class="auth-form-header">
            <h3 data-i18n="welcomeBack">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ</h3>
            <p data-i18n="signInToContinue">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Lumina Studio</p>
          </div>
          
          <div class="form-group">
            <label for="signInEmail" data-i18n="emailAddress">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" id="signInEmail" placeholder="example@email.com">
          </div>
          
          <div class="form-group">
            <label for="signInPassword" data-i18n="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="signInPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          
          <div class="form-actions">
            <button id="signInBtn" class="btn btn-primary" data-i18n="signIn">
              <span class="btn-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
              <span class="spinner" style="display: none;"></span>
            </button>
            
            <div class="auth-divider">
              <span data-i18n="orContinueWith">Ø£Ùˆ ØªØ§Ø¨Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…</span>
            </div>
            
            <button id="googleSignInBtn" class="google-signin-btn">
              <svg class="google-icon" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              <span data-i18n="signInWithGoogle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google</span>
            </button>
          </div>
          
          <div class="auth-switch">
            <span data-i18n="dontHaveAccount">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</span>
            <a id="switchToSignUp" data-i18n="signUp">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a>
          </div>
        </div>
        
        <div class="auth-form" id="signUpForm" style="display: none;">
          <div class="auth-form-header">
            <h3 data-i18n="createAccount">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
            <p data-i18n="joinLuminaStudio">Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Lumina Studio Ù„Ø­ÙØ¸ Ø¹Ù…Ù„Ùƒ</p>
          </div>
          
          <div class="form-group">
            <label for="signUpName" data-i18n="fullName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input type="text" id="signUpName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
          </div>
          
          <div class="form-group">
            <label for="signUpEmail" data-i18n="emailAddress">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" id="signUpEmail" placeholder="example@email.com">
          </div>
          
          <div class="form-group">
            <label for="signUpPassword" data-i18n="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="signUpPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          
          <div class="form-group">
            <label for="signUpConfirmPassword" data-i18n="confirmPassword">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="signUpConfirmPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          
          <div class="form-actions">
            <button id="signUpBtn" class="btn btn-primary" data-i18n="createAccount">
              <span class="btn-text">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span>
              <span class="spinner" style="display: none;"></span>
            </button>
            
            <div class="auth-divider">
              <span data-i18n="orContinueWith">Ø£Ùˆ ØªØ§Ø¨Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…</span>
            </div>
            
            <button id="googleSignUpBtn" class="google-signin-btn">
              <svg class="google-icon" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              <span data-i18n="signUpWithGoogle">Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google</span>
            </button>
          </div>
          
          <div class="auth-switch">
            <span data-i18n="alreadyHaveAccount">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ</span>
            <a id="switchToSignIn" data-i18n="signIn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
          </div>
        </div>
        
        <div class="auth-form" id="userProfile" style="display: none;">
          <div class="auth-form-header">
            <h3 id="profileUserName">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            <p id="profileUserEmail">user@example.com</p>
          </div>
          
          <div class="form-group">
            <label for="profileName" data-i18n="fullName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input type="text" id="profileName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
          </div>
          
          <div class="form-group">
            <label for="profileEmail" data-i18n="emailAddress">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" id="profileEmail" placeholder="example@email.com">
          </div>
          
          <div class="form-actions">
            <button id="updateProfileBtn" class="btn btn-primary" data-i18n="updateProfile">
              <span class="btn-text">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
              <span class="spinner" style="display: none;"></span>
            </button>
            <button id="signOutBtn" class="btn btn-ghost" data-i18n="signOut">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
          </div>
          
          <div class="auth-switch">
            <span data-i18n="accountSynced">Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…ØªØ²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø­Ø³Ø§Ø¨Ùƒ</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</div>
  <canvas id="exportCanvas" style="display:none"></canvas>

  <script>
    /* ---------- Firebase Configuration ---------- */
    // ğŸ”¥ Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙÙŠ Firebase
    // ğŸ”¥ Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ console.firebase.google.com ÙˆØ£Ù†Ø´Ø¦ Ù…Ø´Ø±ÙˆØ¹
    // ğŸ”¥ Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø£Ø¶Ù ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ†
    const firebaseConfig = {
    apiKey: "AIzaSyALohL69p-dfiV3Oua4EYtDlTvtRQmViLY",
    authDomain: "my-project-f5a64.firebaseapp.com",
    projectId: "my-project-f5a64",
    storageBucket: "my-project-f5a64.firebasestorage.app",
    messagingSenderId: "514130850636",
    appId: "1:514130850636:web:87025e1c2e1180a5c155e9",
    measurementId: "G-47X5ERBDY0"
  };

    // Initialize Firebase
    let firebaseApp;
    let firebaseAuth;
    
    try {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      firebaseAuth = firebaseApp.auth();
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization error:", error);
      // Fallback to mock authentication if Firebase fails
    }

    /* ---------- Application State ---------- */
    const state = {
      colors: ['#6366F1','#A855F7','#EC4899'],
      steps: 15,
      vivid: false,
      theme: 'dark',
      generated: [],
      language: 'ar', // Default to Arabic
      userGradients: JSON.parse(localStorage.getItem('luminaUserGradients') || '[]'),
      lastHarmonySeed: 0,
      user: JSON.parse(localStorage.getItem('luminaUser') || 'null'),
      userPreferences: JSON.parse(localStorage.getItem('luminaUserPreferences') || '{}'),
      firebaseAvailable: !!firebaseApp
    };

    const DOM = {
      colorList: document.getElementById('colorList'),
      stepsSlider: document.getElementById('stepsInput'),
      stepsVal: document.getElementById('stepsVal'),
      stepsDecrease: document.getElementById('stepsDecrease'),
      stepsIncrease: document.getElementById('stepsIncrease'),
      vividFlag: document.getElementById('checkVivid'),
      genBase: document.getElementById('genBaseColor'),
      genHex: document.getElementById('genBaseHex'),
      genMode: document.getElementById('genMode'),
      basePosition: document.getElementById('basePosition'),
      btnGen: document.getElementById('btnSmartGenerate'),
      btnAdd: document.getElementById('btnAddColor'),
      btnRandom: document.getElementById('btnRandom'),
      preview: document.getElementById('previewBox'),
      cssText: document.getElementById('cssPreviewText'),
      cssTrigger: document.getElementById('cssPreviewTrigger'),
      strip: document.getElementById('stepsGrid'),
      // Export
      exportToggle: document.getElementById('btnExportToggle'),
      exportMenu: document.getElementById('exportMenu'),
      actions: {
        css: document.getElementById('actCopyCSS'),
        tw: document.getElementById('actCopyTailwind'),
        dlCss: document.getElementById('actDownloadCSS'),
        dlPng: document.getElementById('actDownloadPNG')
      },
      // Modals
      presetsBtn: document.getElementById('openPresetsBtn'),
      presetsModal: document.getElementById('presetsModal'),
      presetsGrid: document.getElementById('presetsGrid'),
      breakdownBtn: document.getElementById('openBreakdownBtn'),
      breakdownModal: document.getElementById('breakdownModal'),
      breakGrid: document.getElementById('breakGrid'),
      // User Gradients
      saveGradientBtn: document.getElementById('saveGradientBtn'),
      userGradientsGrid: document.getElementById('userGradientsGrid'),
      clearSavedGradients: document.getElementById('clearSavedGradients'),
      // Auth
      userAccountBtn: document.getElementById('userAccountBtn'),
      userName: document.getElementById('userName'),
      userAvatar: document.getElementById('userAvatar'),
      authModal: document.getElementById('authModal'),
      authModalTitle: document.getElementById('authModalTitle'),
      authError: document.getElementById('authError'),
      signInForm: document.getElementById('signInForm'),
      signUpForm: document.getElementById('signUpForm'),
      userProfile: document.getElementById('userProfile'),
      signInEmail: document.getElementById('signInEmail'),
      signInPassword: document.getElementById('signInPassword'),
      signInBtn: document.getElementById('signInBtn'),
      signUpName: document.getElementById('signUpName'),
      signUpEmail: document.getElementById('signUpEmail'),
      signUpPassword: document.getElementById('signUpPassword'),
      signUpConfirmPassword: document.getElementById('signUpConfirmPassword'),
      signUpBtn: document.getElementById('signUpBtn'),
      googleSignInBtn: document.getElementById('googleSignInBtn'),
      googleSignUpBtn: document.getElementById('googleSignUpBtn'),
      switchToSignUp: document.getElementById('switchToSignUp'),
      switchToSignIn: document.getElementById('switchToSignIn'),
      updateProfileBtn: document.getElementById('updateProfileBtn'),
      profileName: document.getElementById('profileName'),
      profileEmail: document.getElementById('profileEmail'),
      signOutBtn: document.getElementById('signOutBtn'),
      profileUserName: document.getElementById('profileUserName'),
      profileUserEmail: document.getElementById('profileUserEmail'),
      // Utils
      toast: document.getElementById('toast'),
      canvas: document.getElementById('exportCanvas'),
      themeToggle: document.getElementById('themeToggle'),
      langToggle: document.getElementById('langToggle'),
      langDropdown: document.getElementById('langDropdown'),
      langOptions: document.querySelectorAll('.lang-option'),
      body: document.body,
      baseColorPreview: document.getElementById('baseColorPreview')
    };

    /* ---------- Language Support ---------- */
    const translations = {
      en: {
        appTitle: "Lumina Studio",
        smartGenerator: "Harmony Generator",
        baseColor: "Base Color",
        harmonyMode: "Color Count",
        generatePalette: "Generate New Harmony",
        colorStops: "Color Stops",
        randomize: "Randomize All",
        addStop: "Add Stop",
        configuration: "Configuration",
        stepsPrecision: "Steps / Precision",
        vividMode: "Vivid Mode (LAB)",
        vividDescription: "Perceptually uniform interpolation preventing 'gray dead zones' in gradients.",
        gallery: "Gallery",
        analyze: "Analyze",
        saveGradient: "Save Gradient",
        downloadExport: "Download / Export",
        copyCSS: "ğŸ“‹ Copy CSS",
        copyTailwind: "ğŸ’¨ Copy Tailwind",
        downloadCSS: "ğŸ“„ Download .CSS",
        downloadPNG: "ğŸ–¼ï¸ Download .PNG",
        gradientSpectrum: "Gradient Spectrum",
        spectrumHint: "Hover to identify, click to copy",
        gradientGallery: "Gradient Gallery",
        colorAnalysis: "Color Analysis",
        clickToCopy: "CLICK TO COPY",
        clickToCopyTitle: "Click to copy",
        randomCount: "Random (2-5)",
        twoColors: "2 Colors",
        threeColors: "3 Colors",
        fourColors: "4 Colors",
        fiveColors: "5 Colors",
        basePosition: "Base Color Position",
        atStart: "At Start",
        atEnd: "At End",
        inMiddle: "In Middle",
        randomPosition: "Random",
        builtinGradients: "Built-in Gradients",
        mySavedGradients: "My Saved Gradients",
        clearAll: "Clear All",
        signIn: "Sign In",
        signUp: "Sign Up",
        signOut: "Sign Out",
        welcomeBack: "Welcome Back",
        signInToContinue: "Sign in to continue to Lumina Studio",
        emailAddress: "Email Address",
        password: "Password",
        signInWithGoogle: "Sign in with Google",
        dontHaveAccount: "Don't have an account?",
        createAccount: "Create Account",
        joinLuminaStudio: "Join Lumina Studio to save your work",
        fullName: "Full Name",
        confirmPassword: "Confirm Password",
        signUpWithGoogle: "Sign up with Google",
        alreadyHaveAccount: "Already have an account?",
        updateProfile: "Update Profile",
        accountSynced: "Your data is automatically synced to your account",
        orContinueWith: "Or continue with",
        profile: "Profile",
        loading: "Loading...",
        noSavedGradients: "No saved gradients yet. Create one and click 'Save Gradient'!",
        signInToSaveGradients: "Sign in to save and view your gradients"
      },
      ar: {
        appTitle: "Lumina Studio",
        smartGenerator: "Ù…ÙˆÙ„Ø¯ Ø§Ù„ØªÙ†Ø§ØºÙ…",
        baseColor: "Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ",
        harmonyMode: "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù†",
        generatePalette: "Ø¥Ù†Ø´Ø§Ø¡ ØªÙ†Ø§ØºÙ… Ø¬Ø¯ÙŠØ¯",
        colorStops: "Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ù„ÙˆØ§Ù†",
        randomize: "Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙƒÙ„ÙŠ",
        addStop: "Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø©",
        configuration: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
        stepsPrecision: "Ø§Ù„Ø®Ø·ÙˆØ§Øª / Ø§Ù„Ø¯Ù‚Ø©",
        vividMode: "Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­ÙŠÙˆÙŠ (LAB)",
        vividDescription: "Ø§Ø³ØªÙŠÙØ§Ø¡ Ù…ÙˆØ­Ø¯ Ø¥Ø¯Ø±Ø§ÙƒÙŠØ§Ù‹ ÙŠÙ…Ù†Ø¹ 'Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ© Ø§Ù„Ù…ÙŠØªØ©' ÙÙŠ Ø§Ù„ØªØ¯Ø±Ø¬Ø§Øª.",
        gallery: "Ø§Ù„Ù…Ø¹Ø±Ø¶",
        analyze: "ØªØ­Ù„ÙŠÙ„",
        saveGradient: "Ø­ÙØ¸ Ø§Ù„ØªØ¯Ø±Ø¬",
        downloadExport: "ØªÙ†Ø²ÙŠÙ„ / ØªØµØ¯ÙŠØ±",
        copyCSS: "ğŸ“‹ Ù†Ø³Ø® CSS",
        copyTailwind: "ğŸ’¨ Ù†Ø³Ø® Tailwind",
        downloadCSS: "ğŸ“„ ØªÙ†Ø²ÙŠÙ„ .CSS",
        downloadPNG: "ğŸ–¼ï¸ ØªÙ†Ø²ÙŠÙ„ .PNG",
        gradientSpectrum: "Ø·ÙŠÙ Ø§Ù„ØªØ¯Ø±Ø¬",
        spectrumHint: "Ù…Ø±Ø± Ù„Ù„ØªØ­Ø¯ÙŠØ¯ØŒ Ø§Ù†Ù‚Ø± Ù„Ù„Ù†Ø³Ø®",
        gradientGallery: "Ù…Ø¹Ø±Ø¶ Ø§Ù„ØªØ¯Ø±Ø¬Ø§Øª",
        colorAnalysis: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù†",
        clickToCopy: "Ø§Ù†Ù‚Ø± Ù„Ù„Ù†Ø³Ø®",
        clickToCopyTitle: "Ø§Ù†Ù‚Ø± Ù„Ù„Ù†Ø³Ø®",
        randomCount: "Ø¹Ø´ÙˆØ§Ø¦ÙŠ (2-5)",
        twoColors: "Ù„ÙˆÙ†ÙŠÙ†",
        threeColors: "3 Ø£Ù„ÙˆØ§Ù†",
        fourColors: "4 Ø£Ù„ÙˆØ§Ù†",
        fiveColors: "5 Ø£Ù„ÙˆØ§Ù†",
        basePosition: "Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ",
        atStart: "ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©",
        atEnd: "ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©",
        inMiddle: "ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ",
        randomPosition: "Ø¹Ø´ÙˆØ§Ø¦ÙŠ",
        builtinGradients: "Ø§Ù„ØªØ¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù†Ø©",
        mySavedGradients: "ØªØ¯Ø±Ø¬Ø§ØªÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©",
        clearAll: "Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„",
        signIn: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
        signUp: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨",
        signOut: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
        welcomeBack: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ",
        signInToContinue: "Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Lumina Studio",
        emailAddress: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
        password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        signInWithGoogle: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google",
        dontHaveAccount: "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ",
        createAccount: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨",
        joinLuminaStudio: "Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Lumina Studio Ù„Ø­ÙØ¸ Ø¹Ù…Ù„Ùƒ",
        fullName: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„",
        confirmPassword: "ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
        signUpWithGoogle: "Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google",
        alreadyHaveAccount: "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ",
        updateProfile: "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",
        accountSynced: "Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…ØªØ²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø­Ø³Ø§Ø¨Ùƒ",
        orContinueWith: "Ø£Ùˆ ØªØ§Ø¨Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…",
        profile: "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",
        loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
        noSavedGradients: "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¯Ø±Ø¬Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯Ø© ÙˆØ§Ù†Ù‚Ø± Ø¹Ù„Ù‰ 'Ø­ÙØ¸ Ø§Ù„ØªØ¯Ø±Ø¬'!",
        signInToSaveGradients: "Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ ÙˆÙ…Ø´Ø§Ù‡Ø¯Ø© ØªØ¯Ø±Ø¬Ø§ØªÙƒ"
      }
    };

    /* ---------- Language Auto-detection ---------- */
    function detectBrowserLanguage() {
      const browserLang = navigator.language || navigator.userLanguage;
      const langCode = browserLang.split('-')[0];
      
      // Supported languages
      const supportedLangs = ['en', 'ar', 'fr', 'es', 'de', 'zh', 'ja', 'ru', 'tr', 'pt', 'hi', 'ko', 'it'];
      
      if (supportedLangs.includes(langCode)) {
        return langCode;
      }
      
      return 'ar'; // Default to Arabic
    }

    function setLanguage(lang) {
      state.language = lang;
      DOM.body.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
      
      const langNames = {
        en: "EN", ar: "AR", fr: "FR", es: "ES", 
        de: "DE", zh: "ZH", ja: "JA", ru: "RU",
        tr: "TR", pt: "PT", hi: "HI", ko: "KO", it: "IT"
      };
      DOM.langToggle.textContent = `ğŸŒ ${langNames[lang]}`;
      
      DOM.langOptions.forEach(option => {
        if (option.dataset.lang === lang) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
      
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
          el.textContent = translations[lang][key];
        } else if (translations['en'][key]) {
          el.textContent = translations['en'][key];
        }
      });
      
      document.querySelectorAll('[data-i18n-title]').forEach(el => {
        const key = el.getAttribute('data-i18n-title');
        if (translations[lang] && translations[lang][key]) {
          el.title = translations[lang][key];
        } else if (translations['en'][key]) {
          el.title = translations['en'][key];
        }
      });
      
      document.querySelectorAll('select option').forEach(option => {
        const key = option.getAttribute('data-i18n');
        if (key && translations[lang] && translations[lang][key]) {
          option.textContent = translations[lang][key];
        } else if (key && translations['en'][key]) {
          option.textContent = translations['en'][key];
        }
      });
      
      // Save language preference
      saveUserPreferences();
      
      // Update button text for loading states
      updateButtonLoadingStates();
    }

    // Helper function to update button loading states
    function updateButtonLoadingStates() {
      const buttons = [
        { btn: DOM.signInBtn, textKey: 'signIn' },
        { btn: DOM.signUpBtn, textKey: 'createAccount' },
        { btn: DOM.updateProfileBtn, textKey: 'updateProfile' }
      ];
      
      buttons.forEach(({ btn, textKey }) => {
        if (btn) {
          const btnText = btn.querySelector('.btn-text');
          if (btnText) {
            btnText.textContent = translations[state.language][textKey] || translations['en'][textKey];
          }
        }
      });
    }

    // Helper function to get localized messages
    function getMessage(key) {
      const messages = {
        languageChanged: {
          en: 'Language changed to English',
          ar: 'ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
          fr: 'Langue changÃ©e en franÃ§ais',
          es: 'Idioma cambiado a espaÃ±ol',
          de: 'Sprache zu Deutsch geÃ¤ndert',
          zh: 'è¯­è¨€å·²æ›´æ”¹ä¸ºä¸­æ–‡',
          ja: 'è¨€èªãŒæ—¥æœ¬èªã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸ',
          ru: 'Ğ¯Ğ·Ñ‹Ğº Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹',
          tr: 'Dil TÃ¼rkÃ§e olarak deÄŸiÅŸtirildi',
          pt: 'Idioma alterado para portuguÃªs',
          hi: 'à¤­à¤¾à¤·à¤¾ à¤¹à¤¿à¤‚à¤¦à¥€ à¤®à¥‡à¤‚ à¤¬à¤¦à¤²à¥€ à¤—à¤ˆ',
          ko: 'ì–¸ì–´ê°€ í•œêµ­ì–´ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤',
          it: 'Lingua cambiata in italiano'
        },
        paletteGenerated: {
          en: 'New harmonious palette generated',
          ar: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø£Ù„ÙˆØ§Ù† Ù…ØªÙ†Ø§Ø³Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©',
          fr: 'Nouvelle palette harmonieuse gÃ©nÃ©rÃ©e',
          es: 'Nueva paleta armÃ³nica generada',
          de: 'Neue harmonische Palette erstellt',
          zh: 'æ–°çš„å’Œè°è°ƒè‰²æ¿å·²ç”Ÿæˆ',
          ja: 'æ–°ã—ã„èª¿å’Œãƒ‘ãƒ¬ãƒƒãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ',
          ru: 'ĞĞ¾Ğ²Ğ°Ñ Ğ³Ğ°Ñ€Ğ¼Ğ¾Ğ½Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ¿Ğ°Ğ»Ğ¸Ñ‚Ñ€Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°',
          tr: 'Yeni uyumlu palet oluÅŸturuldu',
          pt: 'Nova paleta harmoniosa gerada',
          hi: 'à¤¨à¤¯à¤¾ à¤¸à¤¾à¤®à¤‚à¤œà¤¸à¥à¤¯à¤ªà¥‚à¤°à¥à¤£ à¤ªà¥ˆà¤²à¥‡à¤Ÿ à¤‰à¤¤à¥à¤ªà¤¨à¥à¤¨ à¤¹à¥à¤†',
          ko: 'ìƒˆë¡œìš´ ì¡°í™”ë¡œìš´ íŒ”ë ˆíŠ¸ ìƒì„±ë¨',
          it: 'Nuova palette armoniosa generata'
        },
        gradientSaved: {
          en: 'Gradient saved to your gallery',
          ar: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¯Ø±Ø¬ ÙÙŠ Ù…Ø¹Ø±Ø¶Ùƒ',
          fr: 'DÃ©gradÃ© enregistrÃ© dans votre galerie',
          es: 'Degradado guardado en tu galerÃ­a',
          de: 'Verlauf in deiner Galerie gespeichert',
          zh: 'æ¸å˜å·²ä¿å­˜åˆ°æ‚¨çš„ç”»å»Š',
          ja: 'ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ',
          ru: 'Ğ“Ñ€Ğ°Ğ´Ğ¸ĞµĞ½Ñ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½ Ğ² Ğ²Ğ°ÑˆÑƒ Ğ³Ğ°Ğ»ĞµÑ€ĞµÑ',
          tr: 'Gradyan galerinize kaydedildi',
          pt: 'Gradiente guardado na sua galeria',
          hi: 'à¤—à¥à¤°à¥‡à¤¡à¤¿à¤à¤‚à¤Ÿ à¤†à¤ªà¤•à¥€ à¤—à¥ˆà¤²à¤°à¥€ à¤®à¥‡à¤‚ à¤¸à¤¹à¥‡à¤œà¤¾ à¤—à¤¯à¤¾',
          ko: 'ê·¸ë¼ë°ì´ì…˜ì´ ê°¤ëŸ¬ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤',
          it: 'Gradiente salvato nella tua galleria'
        },
        signedIn: {
          en: 'Signed in successfully',
          ar: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­',
          fr: 'ConnectÃ© avec succÃ¨s',
          es: 'IniciÃ³ sesiÃ³n con Ã©xito',
          de: 'Erfolgreich angemeldet',
          zh: 'ç™»å½•æˆåŠŸ',
          ja: 'ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸ',
          ru: 'Ğ’Ñ…Ğ¾Ğ´ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾',
          tr: 'BaÅŸarÄ±yla giriÅŸ yapÄ±ldÄ±',
          pt: 'SessÃ£o iniciada com sucesso',
          hi: 'à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤¸à¤¾à¤‡à¤¨ à¤‡à¤¨ à¤•à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾',
          ko: 'ë¡œê·¸ì¸ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤',
          it: 'Accesso eseguito con successo'
        },
        signedOut: {
          en: 'Signed out successfully',
          ar: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­',
          fr: 'DÃ©connectÃ© avec succÃ¨s',
          es: 'CerrÃ³ sesiÃ³n con Ã©xito',
          de: 'Erfolgreich abgemeldet',
          zh: 'é€€å‡ºç™»å½•æˆåŠŸ',
          ja: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«æˆåŠŸã—ã¾ã—ãŸ',
          ru: 'Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾',
          tr: 'BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yapÄ±ldÄ±',
          pt: 'SessÃ£o terminada com sucesso',
          hi: 'à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤¸à¤¾à¤‡à¤¨ à¤†à¤‰à¤Ÿ à¤•à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾',
          ko: 'ë¡œê·¸ì•„ì›ƒì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤',
          it: 'Uscita eseguita con successo'
        },
        accountCreated: {
          en: 'Account created successfully',
          ar: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­',
          fr: 'Compte crÃ©Ã© avec succÃ¨s',
          es: 'Cuenta creada con Ã©xito',
          de: 'Konto erfolgreich erstellt',
          zh: 'è´¦æˆ·åˆ›å»ºæˆåŠŸ',
          ja: 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ',
          ru: 'ĞĞºĞºĞ°ÑƒĞ½Ñ‚ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½',
          tr: 'Hesap baÅŸarÄ±yla oluÅŸturuldu',
          pt: 'Conta criada com sucesso',
          hi: 'à¤–à¤¾à¤¤à¤¾ à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤¬à¤¨à¤¾à¤¯à¤¾ à¤—à¤¯à¤¾',
          ko: 'ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤',
          it: 'Account creato con successo'
        }
      };
      return messages[key] && messages[key][state.language] ? messages[key][state.language] : messages[key].en;
    }

    /* ---------- Color Utilities ---------- */
    const clamp = (v,a,b) => Math.max(a,Math.min(b,v));
    const normHex = (h) => {
      if(!h) return '#000000';
      h = String(h).trim().toUpperCase();
      if(!h.startsWith('#')) h = '#'+h;
      if(/^#[0-9A-F]{3}$/i.test(h)) h = '#'+h.slice(1).split('').map(x=>x+x).join('');
      return /^#[0-9A-F]{6}$/i.test(h) ? h : '#000000';
    };
    const hexToRgb = (hex) => {
      hex = normHex(hex).slice(1);
      return {r:parseInt(hex.slice(0,2),16), g:parseInt(hex.slice(2,4),16), b:parseInt(hex.slice(4,6),16)};
    };
    const rgbToHex = (r,g,b) => '#'+[r,g,b].map(x=>clamp(Math.round(x),0,255).toString(16).padStart(2,'0')).join('').toUpperCase();
    
    // RGB to HSL conversion
    function rgbToHsl(r, g, b) {
      r /= 255; g /= 255; b /= 255;
      const max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;
      
      if (max === min) {
        h = s = 0;
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch(max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
      }
      return [h, s, l];
    }
    
    // HSL to RGB conversion
    function hslToRgb(h, s, l) {
      let r, g, b;
      
      if (s === 0) {
        r = g = b = l;
      } else {
        const hue2rgb = (p, q, t) => {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1/6) return p + (q - p) * 6 * t;
          if (t < 1/2) return q;
          if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
          return p;
        };
        
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);
      }
      
      return [r * 255, g * 255, b * 255];
    }

    // Generate new random harmonious colors based on base color
    function generateNewHarmoniousColors(baseColor) {
      const baseRgb = hexToRgb(baseColor);
      const [h, s, l] = rgbToHsl(baseRgb.r, baseRgb.g, baseRgb.b);
      
      // Increment seed for different results each time
      state.lastHarmonySeed = (state.lastHarmonySeed + 1) % 1000;
      
      // Get color count
      let count;
      if (DOM.genMode.value === 'random') {
        count = Math.floor(Math.random() * 4) + 2; // 2-5 colors
      } else {
        count = parseInt(DOM.genMode.value);
      }
      
      // Get base position
      const position = DOM.basePosition.value;
      
      const colors = [];
      
      // Generate harmonious colors with different variations each time
      for (let i = 0; i < count; i++) {
        // Use seed to create deterministic but different results
        const seed = state.lastHarmonySeed + i * 123;
        const randomFactor = Math.sin(seed) * 0.5 + 0.5; // 0-1 range
        
        // Create variations by adjusting hue, saturation, and lightness
        let newH = (h + (randomFactor * 0.4)) % 1; // Different hue shift each time
        let newS = clamp(s + (Math.sin(seed * 1.3) * 0.3 - 0.15), 0.3, 0.9);
        let newL = clamp(l + (Math.cos(seed * 0.7) * 0.3 - 0.15), 0.2, 0.8);
        
        // For complementary colors (every other color)
        if (i % 2 === 1 && count > 2) {
          newH = (h + 0.5 + randomFactor * 0.1) % 1; // Complementary with variation
          newL = clamp(l + 0.1 + Math.sin(seed) * 0.1, 0.2, 0.8);
        }
        
        const [r, g, b] = hslToRgb(newH, newS, newL);
        colors.push(rgbToHex(Math.round(r), Math.round(g), Math.round(b)));
      }
      
      // Place base color according to position
      const baseColorHex = normHex(baseColor);
      let finalColors = [...colors];
      
      switch(position) {
        case 'start':
          finalColors = [baseColorHex, ...colors.slice(0, count-1)];
          break;
        case 'end':
          finalColors = [...colors.slice(0, count-1), baseColorHex];
          break;
        case 'middle':
          const middleIndex = Math.floor(count / 2);
          finalColors[middleIndex] = baseColorHex;
          break;
        case 'random':
          const randomIndex = Math.floor(Math.random() * count);
          finalColors[randomIndex] = baseColorHex;
          break;
      }
      
      return finalColors.slice(0, count);
    }

    // Simple Linear Blend
    function blendHex(a,b,t){
      const A=hexToRgb(a), B=hexToRgb(b);
      return rgbToHex(
        A.r+(B.r-A.r)*t,
        A.g+(B.g-A.g)*t,
        A.b+(B.b-A.b)*t
      );
    }

    /* ---------- Gradient Generation ---------- */
    function interpolate(stops, steps, mode='linear'){
      if(stops.length<2) return Array(steps).fill(stops[0]);
      const result = [];
      const segments = stops.length - 1;
      
      for(let s=0; s<segments; s++){
        const c1 = stops[s], c2 = stops[s+1];
        const segSteps = Math.floor(steps/segments) + (s < steps%segments ? 1 : 0);
        
        if(mode === 'lab'){
          // For simplicity, using linear interpolation
          for(let i=0; i<segSteps; i++){
            if (s === segments-1 && i === segSteps-1) {
                result.push(stops[stops.length-1]);
                continue;
            }
            result.push(blendHex(c1, c2, i/segSteps));
          }
        } else {
           for(let i=0; i<segSteps; i++){
             if (s === segments-1 && i === segSteps-1) {
                result.push(stops[stops.length-1]);
                continue;
             }
             result.push(blendHex(c1, c2, i/segSteps));
           }
        }
      }
      while(result.length < steps) result.push(stops[stops.length-1]);
      return result.slice(0,steps);
    }

    /* ---------- Random Color Generator ---------- */
    function generateRandomColors(count = 3) {
      const colors = [];
      for(let i = 0; i < count; i++) {
        const r = Math.floor(Math.random() * 256);
        const g = Math.floor(Math.random() * 256);
        const b = Math.floor(Math.random() * 256);
        colors.push(rgbToHex(r, g, b));
      }
      return colors;
    }

    /* ---------- Firebase Authentication ---------- */
    // Real authentication with Firebase
    const AuthService = {
      // Sign in with email/password using Firebase
      async signInWithEmail(email, password) {
        try {
          if (!firebaseAuth) {
            throw new Error('Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
          }
          
          const userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
          const user = userCredential.user;
          
          return {
            id: user.uid,
            name: user.displayName || user.email.split('@')[0],
            email: user.email,
            avatar: this.generateAvatar(user.displayName || user.email),
            emailVerified: user.emailVerified
          };
        } catch (error) {
          let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
          
          switch(error.code) {
            case 'auth/user-not-found':
              errorMessage = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
              break;
            case 'auth/wrong-password':
              errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
              break;
            case 'auth/invalid-email':
              errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
              break;
            case 'auth/user-disabled':
              errorMessage = 'ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨';
              break;
            case 'auth/too-many-requests':
              errorMessage = 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙƒØ«ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹';
              break;
            default:
              errorMessage = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
          }
          
          throw new Error(errorMessage);
        }
      },
      
      // Sign up with email/password using Firebase
      async signUpWithEmail(name, email, password) {
        try {
          if (!firebaseAuth) {
            throw new Error('Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
          }
          
          const userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;
          
          // Update display name
          await user.updateProfile({
            displayName: name
          });
          
          // Send email verification
          await user.sendEmailVerification();
          
          return {
            id: user.uid,
            name: name,
            email: user.email,
            avatar: this.generateAvatar(name),
            emailVerified: false
          };
        } catch (error) {
          let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
          
          switch(error.code) {
            case 'auth/email-already-in-use':
              errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
              break;
            case 'auth/invalid-email':
              errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
              break;
            case 'auth/operation-not-allowed':
              errorMessage = 'Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§';
              break;
            case 'auth/weak-password':
              errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹';
              break;
            default:
              errorMessage = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
          }
          
          throw new Error(errorMessage);
        }
      },
      
      // Sign in with Google using Firebase
      async signInWithGoogle() {
        try {
          if (!firebaseAuth) {
            throw new Error('Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
          }
          
          const provider = new firebase.auth.GoogleAuthProvider();
          // Add Arabic language preference
          provider.setCustomParameters({
            'hl': 'ar'
          });
          
          const userCredential = await firebaseAuth.signInWithPopup(provider);
          const user = userCredential.user;
          
          return {
            id: user.uid,
            name: user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù… Google',
            email: user.email,
            avatar: this.generateAvatar(user.displayName),
            emailVerified: user.emailVerified
          };
        } catch (error) {
          let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¹ Google';
          
          switch(error.code) {
            case 'auth/popup-closed-by-user':
              errorMessage = 'ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
              break;
            case 'auth/cancelled-popup-request':
              errorMessage = 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
              break;
            case 'auth/popup-blocked':
              errorMessage = 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©';
              break;
            default:
              errorMessage = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
          }
          
          throw new Error(errorMessage);
        }
      },
      
      // Sign out using Firebase
      async signOut() {
        try {
          if (firebaseAuth) {
            await firebaseAuth.signOut();
          }
          return true;
        } catch (error) {
          console.error('Sign out error:', error);
          return false;
        }
      },
      
      // Update user profile
      async updateProfile(userId, updates) {
        try {
          if (!firebaseAuth || !firebaseAuth.currentUser) {
            throw new Error('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
          }
          
          const user = firebaseAuth.currentUser;
          
          if (updates.name) {
            await user.updateProfile({
              displayName: updates.name
            });
          }
          
          if (updates.email && updates.email !== user.email) {
            await user.updateEmail(updates.email);
          }
          
          // Get updated user data
          const updatedUser = firebaseAuth.currentUser;
          
          return {
            id: updatedUser.uid,
            name: updatedUser.displayName || updates.name,
            email: updatedUser.email,
            avatar: this.generateAvatar(updatedUser.displayName || updates.name),
            emailVerified: updatedUser.emailVerified
          };
        } catch (error) {
          let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ';
          
          switch(error.code) {
            case 'auth/requires-recent-login':
              errorMessage = 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';
              break;
            case 'auth/email-already-in-use':
              errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
              break;
            default:
              errorMessage = error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
          }
          
          throw new Error(errorMessage);
        }
      },
      
      // Get current user from Firebase
      getCurrentUser() {
        if (!firebaseAuth) return null;
        
        const user = firebaseAuth.currentUser;
        if (!user) return null;
        
        return {
          id: user.uid,
          name: user.displayName || user.email.split('@')[0],
          email: user.email,
          avatar: this.generateAvatar(user.displayName || user.email),
          emailVerified: user.emailVerified
        };
      },
      
      // Check auth state
      onAuthStateChanged(callback) {
        if (!firebaseAuth) {
          callback(null);
          return () => {};
        }
        
        return firebaseAuth.onAuthStateChanged((firebaseUser) => {
          if (firebaseUser) {
            const user = {
              id: firebaseUser.uid,
              name: firebaseUser.displayName || firebaseUser.email.split('@')[0],
              email: firebaseUser.email,
              avatar: this.generateAvatar(firebaseUser.displayName || firebaseUser.email),
              emailVerified: firebaseUser.emailVerified
            };
            callback(user);
          } else {
            callback(null);
          }
        });
      },
      
      // Generate avatar from name
      generateAvatar(name) {
        if (!name) return 'ğŸ‘¤';
        
        const names = name.split(' ');
        let initials = '';
        
        // Handle Arabic and English names
        if (names.length > 0) {
          // Get first character of first name
          const firstChar = names[0].charAt(0);
          // Check if it's Arabic
          if (/[\u0600-\u06FF]/.test(firstChar)) {
            initials = firstChar;
          } else {
            initials = firstChar.toUpperCase();
          }
        }
        
        if (names.length > 1) {
          // Get first character of last name
          const lastChar = names[names.length - 1].charAt(0);
          if (/[\u0600-\u06FF]/.test(lastChar)) {
            initials += lastChar;
          } else {
            initials += lastChar.toUpperCase();
          }
        }
        
        return initials || 'ğŸ‘¤';
      }
    };

    /* ---------- User Management Functions ---------- */
    function showLoading(button, show) {
      if (!button) return;
      
      const btnText = button.querySelector('.btn-text');
      const spinner = button.querySelector('.spinner');
      
      if (btnText && spinner) {
        if (show) {
          btnText.style.display = 'none';
          spinner.style.display = 'inline-block';
          button.disabled = true;
        } else {
          btnText.style.display = 'inline-block';
          spinner.style.display = 'none';
          button.disabled = false;
        }
      }
    }

    async function signIn(email, password) {
      DOM.authError.classList.remove('show');
      showLoading(DOM.signInBtn, true);
      
      try {
        const user = await AuthService.signInWithEmail(email, password);
        state.user = user;
        localStorage.setItem('luminaUser', JSON.stringify(user));
        updateUserUI();
        toggleModal('authModal', false);
        showToast(getMessage('signedIn'));
        loadUserData();
      } catch (error) {
        DOM.authError.textContent = error.message;
        DOM.authError.classList.add('show');
      } finally {
        showLoading(DOM.signInBtn, false);
      }
    }
    
    async function signUp(name, email, password, confirmPassword) {
      DOM.authError.classList.remove('show');
      showLoading(DOM.signUpBtn, true);
      
      // Validation
      if (!name || !email || !password) {
        DOM.authError.textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©';
        DOM.authError.classList.add('show');
        showLoading(DOM.signUpBtn, false);
        return;
      }
      
      if (password !== confirmPassword) {
        DOM.authError.textContent = 'ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©';
        DOM.authError.classList.add('show');
        showLoading(DOM.signUpBtn, false);
        return;
      }
      
      if (password.length < 6) {
        DOM.authError.textContent = 'ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
        DOM.authError.classList.add('show');
        showLoading(DOM.signUpBtn, false);
        return;
      }
      
      try {
        const user = await AuthService.signUpWithEmail(name, email, password);
        state.user = user;
        localStorage.setItem('luminaUser', JSON.stringify(user));
        updateUserUI();
        toggleModal('authModal', false);
        showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„ØªØ­Ù‚Ù‚.');
        loadUserData();
      } catch (error) {
        DOM.authError.textContent = error.message;
        DOM.authError.classList.add('show');
      } finally {
        showLoading(DOM.signUpBtn, false);
      }
    }
    
    async function signInWithGoogle() {
      DOM.authError.classList.remove('show');
      
      try {
        const user = await AuthService.signInWithGoogle();
        state.user = user;
        localStorage.setItem('luminaUser', JSON.stringify(user));
        updateUserUI();
        toggleModal('authModal', false);
        showToast(getMessage('signedIn'));
        loadUserData();
      } catch (error) {
        DOM.authError.textContent = error.message;
        DOM.authError.classList.add('show');
      }
    }
    
    async function signOut() {
      try {
        await AuthService.signOut();
        state.user = null;
        localStorage.removeItem('luminaUser');
        updateUserUI();
        toggleModal('authModal', false);
        showToast(getMessage('signedOut'));
        
        // Reset to default colors when signed out
        state.colors = ['#6366F1','#A855F7','#EC4899'];
        refresh();
      } catch (error) {
        console.error('Sign out error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
      }
    }
    
    async function updateProfile() {
      const name = DOM.profileName.value;
      const email = DOM.profileEmail.value;
      
      if (!name || !email) {
        DOM.authError.textContent = 'Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†';
        DOM.authError.classList.add('show');
        return;
      }
      
      showLoading(DOM.updateProfileBtn, true);
      
      try {
        const updatedUser = await AuthService.updateProfile(state.user.id, { name, email });
        state.user = updatedUser;
        localStorage.setItem('luminaUser', JSON.stringify(updatedUser));
        updateUserUI();
        showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
      } catch (error) {
        DOM.authError.textContent = error.message;
        DOM.authError.classList.add('show');
      } finally {
        showLoading(DOM.updateProfileBtn, false);
      }
    }
    
    function updateUserUI() {
      if (state.user) {
        DOM.userName.textContent = state.user.name;
        DOM.userAvatar.textContent = state.user.avatar;
        
        // Update profile form
        DOM.profileName.value = state.user.name;
        DOM.profileEmail.value = state.user.email;
        DOM.profileUserName.textContent = state.user.name;
        DOM.profileUserEmail.textContent = state.user.email;
        
        // Show email verification status
        if (state.user.emailVerified === false) {
          const verificationMsg = document.createElement('div');
          verificationMsg.className = 'auth-error';
          verificationMsg.style.background = 'rgba(234, 179, 8, 0.1)';
          verificationMsg.style.borderColor = 'rgba(234, 179, 8, 0.2)';
          verificationMsg.style.color = '#ca8a04';
          verificationMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';
          verificationMsg.style.marginBottom = '12px';
          verificationMsg.style.display = 'block';
          
          // Check if already added
          const existingMsg = DOM.userProfile.querySelector('.verification-msg');
          if (!existingMsg) {
            verificationMsg.classList.add('verification-msg');
            DOM.userProfile.insertBefore(verificationMsg, DOM.userProfile.firstChild);
          }
        } else {
          const existingMsg = DOM.userProfile.querySelector('.verification-msg');
          if (existingMsg) {
            existingMsg.remove();
          }
        }
        
        // Show user profile in auth modal
        DOM.signInForm.style.display = 'none';
        DOM.signUpForm.style.display = 'none';
        DOM.userProfile.style.display = 'block';
        DOM.authModalTitle.textContent = translations[state.language]?.profile || 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ';
      } else {
        DOM.userName.textContent = translations[state.language]?.signIn || 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        DOM.userAvatar.textContent = 'ğŸ‘¤';
        
        // Show sign in form
        DOM.signInForm.style.display = 'block';
        DOM.signUpForm.style.display = 'none';
        DOM.userProfile.style.display = 'none';
        DOM.authModalTitle.textContent = translations[state.language]?.signIn || 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      }
    }
    
    function toggleAuthForm(showSignUp) {
      DOM.authError.classList.remove('show');
      
      if (showSignUp) {
        DOM.signInForm.style.display = 'none';
        DOM.signUpForm.style.display = 'block';
        DOM.userProfile.style.display = 'none';
        DOM.authModalTitle.textContent = translations[state.language]?.signUp || 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
      } else {
        DOM.signInForm.style.display = 'block';
        DOM.signUpForm.style.display = 'none';
        DOM.userProfile.style.display = 'none';
        DOM.authModalTitle.textContent = translations[state.language]?.signIn || 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      }
    }

    /* ---------- User Data Management ---------- */
    function saveUserPreferences() {
      state.userPreferences = {
        colors: state.colors,
        steps: state.steps,
        vivid: state.vivid,
        theme: state.theme,
        language: state.language
      };
      
      localStorage.setItem('luminaUserPreferences', JSON.stringify(state.userPreferences));
      
      // If user is signed in, we could sync to cloud here
      if (state.user) {
        // In a real app, you would sync to a backend
        console.log('User preferences saved (would sync to cloud in production)');
      }
    }
    
    function loadUserPreferences() {
      const savedPrefs = JSON.parse(localStorage.getItem('luminaUserPreferences') || '{}');
      
      if (savedPrefs.colors && savedPrefs.colors.length > 0) {
        state.colors = savedPrefs.colors;
      }
      
      if (savedPrefs.steps) {
        state.steps = savedPrefs.steps;
        DOM.stepsSlider.value = state.steps;
      }
      
      if (savedPrefs.vivid !== undefined) {
        state.vivid = savedPrefs.vivid;
        DOM.vividFlag.checked = state.vivid;
      }
      
      if (savedPrefs.theme) {
        state.theme = savedPrefs.theme;
        document.body.setAttribute('data-theme', state.theme);
      }
      
      if (savedPrefs.language) {
        state.language = savedPrefs.language;
      }
    }
    
    function loadUserData() {
      // Load user preferences
      loadUserPreferences();
      
      // Load user gradients
      state.userGradients = JSON.parse(localStorage.getItem('luminaUserGradients') || '[]');
      renderUserGradients();
      
      // Refresh UI with loaded data
      refresh();
    }

    /* ---------- Presets ---------- */
    const PRESETS = [
      { name: 'Sunset Glow', colors: ['#ff7e5f','#feb47b'] },
      { name: 'Oceanic', colors: ['#00c6ff','#0072ff'] },
      { name: 'Hyper Violet', colors: ['#8e2de2','#4a00e0'] },
      { name: 'Cotton Candy', colors: ['#ec4899','#f97316'] },
      { name: 'Mint Leaf', colors: ['#10b981','#047857'] },
      { name: 'Cyberpunk', colors: ['#ff0066','#8b5cf6','#00d4ff'] },
      { name: 'Midnight', colors: ['#0f172a','#334155'] },
      { name: 'Golden Hour', colors: ['#f5af19','#f12711'] },
      { name: 'Sunrise', colors: ['#ff7e5f','#feb47b','#ffd166'] },
      { name: 'Forest', colors: ['#1a936f','#88d498','#c6dabf'] },
      { name: 'Purple Dream', colors: ['#a463f2','#ff8ce6','#00d4ff'] },
      { name: 'Coral Reef', colors: ['#ff6b6b','#ffa36c','#ffd166'] },
      { name: 'Arctic', colors: ['#a8e6cf','#dcedc1','#ffd3b6'] },
      { name: 'Desert', colors: ['#ffd166','#ef476f','#06d6a0'] },
      { name: 'Galaxy', colors: ['#3a0ca3','#4361ee','#4cc9f0'] },
      { name: 'Autumn', colors: ['#e63946','#f1faee','#a8dadc'] },
      { name: 'Spring', colors: ['#ffafcc','#bde0fe','#a2d2ff'] },
      { name: 'Summer', colors: ['#ffbe0b','#fb5607','#ff006e'] },
      { name: 'Winter', colors: ['#8ecae6','#219ebc','#023047'] },
      { name: 'Neon Lights', colors: ['#ff006e','#8338ec','#3a86ff'] }
    ];

    /* ---------- User Gradients ---------- */
    function saveCurrentGradient() {
      if (!state.user) {
        showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ø§Ù„ØªØ¯Ø±Ø¬Ø§Øª');
        toggleModal('authModal', true);
        return;
      }
      
      const gradientName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ¯Ø±Ø¬:', `ØªØ¯Ø±Ø¬ÙŠ ${state.userGradients.length + 1}`);
      if (!gradientName) return;
      
      const gradient = {
        name: gradientName,
        colors: [...state.colors],
        date: new Date().toISOString(),
        userId: state.user.id
      };
      
      state.userGradients.unshift(gradient);
      if (state.userGradients.length > 50) {
        state.userGradients = state.userGradients.slice(0, 50);
      }
      
      localStorage.setItem('luminaUserGradients', JSON.stringify(state.userGradients));
      renderUserGradients();
      showToast(getMessage('gradientSaved'));
    }
    
    function renderUserGradients() {
      DOM.userGradientsGrid.innerHTML = '';
      
      // Filter gradients by user if signed in
      let userGradients = state.userGradients;
      if (state.user) {
        userGradients = state.userGradients.filter(g => g.userId === state.user.id);
      } else {
        userGradients = [];
      }
      
      if (userGradients.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.gridColumn = '1 / -1';
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.padding = '20px';
        emptyMsg.style.color = 'var(--text-muted)';
        emptyMsg.textContent = state.user 
          ? (translations[state.language]?.noSavedGradients || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¯Ø±Ø¬Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯Ø© ÙˆØ§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø­ÙØ¸ Ø§Ù„ØªØ¯Ø±Ø¬"!')
          : (translations[state.language]?.signInToSaveGradients || 'Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ ÙˆÙ…Ø´Ø§Ù‡Ø¯Ø© ØªØ¯Ø±Ø¬Ø§ØªÙƒ');
        DOM.userGradientsGrid.appendChild(emptyMsg);
        return;
      }
      
      userGradients.forEach((gradient, index) => {
        const card = document.createElement('div'); 
        card.className = 'preset-item';
        
        // Create preview with strips
        const prev = document.createElement('div'); 
        prev.className='preset-preview';
        
        // Generate gradient from gradient colors
        const gradientColors = interpolate(gradient.colors, 10, 'linear');
        
        gradientColors.forEach(c => {
          const strip = document.createElement('div');
          strip.className = 'preset-strip';
          strip.style.backgroundColor = c;
          prev.appendChild(strip);
        });
        
        const info = document.createElement('div'); 
        info.className='preset-info';
        info.style.display = 'flex';
        info.style.justifyContent = 'space-between';
        info.style.alignItems = 'center';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = gradient.name;
        nameSpan.style.flex = '1';
        nameSpan.style.overflow = 'hidden';
        nameSpan.style.textOverflow = 'ellipsis';
        nameSpan.style.whiteSpace = 'nowrap';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-icon';
        deleteBtn.innerHTML = 'âœ•';
        deleteBtn.style.fontSize = '0.7rem';
        deleteBtn.style.padding = '4px';
        deleteBtn.title = 'Ø­Ø°Ù Ø§Ù„ØªØ¯Ø±Ø¬';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          // Find actual index in state.userGradients
          const actualIndex = state.userGradients.findIndex(g => 
            g.name === gradient.name && 
            g.colors.join(',') === gradient.colors.join(',') &&
            g.date === gradient.date
          );
          if (actualIndex !== -1) {
            state.userGradients.splice(actualIndex, 1);
            localStorage.setItem('luminaUserGradients', JSON.stringify(state.userGradients));
            renderUserGradients();
            showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ¯Ø±Ø¬');
          }
        });
        
        info.appendChild(nameSpan);
        info.appendChild(deleteBtn);
        
        card.appendChild(prev); 
        card.appendChild(info);
        card.onclick = () => {
            state.colors = [...gradient.colors];
            refresh();
            toggleModal('presetsModal', false);
            showToast(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ${gradient.name}`);
        };
        DOM.userGradientsGrid.appendChild(card);
      });
    }
    
    function clearSavedGradients() {
      if (!state.user) return;
      
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ')) {
        // Only clear gradients for this user
        state.userGradients = state.userGradients.filter(g => g.userId !== state.user.id);
        localStorage.setItem('luminaUserGradients', JSON.stringify(state.userGradients));
        renderUserGradients();
        showToast('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
      }
    }

    /* ---------- Rendering & UI ---------- */
    function renderStops(){
      DOM.colorList.innerHTML = '';
      state.colors.forEach((color, i) => {
        const row = document.createElement('div'); row.className = 'color-row';
        
        // Preview/Picker
        const prev = document.createElement('div'); prev.className = 'color-preview';
        prev.style.backgroundColor = color;
        const input = document.createElement('input'); input.type='color'; input.className='color-picker-trigger'; input.value=color;
        input.addEventListener('input', e => updateStop(i, e.target.value));
        prev.appendChild(input);
        
        // Hex Text
        const text = document.createElement('input'); text.type='text'; text.className='hex-input'; text.value=color;
        text.style.width='90px';
        text.addEventListener('change', e => updateStop(i, e.target.value));
        
        // Actions
        const actions = document.createElement('div'); actions.style.marginLeft='auto'; actions.style.display='flex'; actions.style.gap='4px';
        
        if(i > 0) {
            const up = document.createElement('button'); up.className='btn-icon'; up.innerHTML='â†‘';
            up.onclick = () => swap(i, i-1);
            actions.appendChild(up);
        }
        if(i < state.colors.length-1) {
            const down = document.createElement('button'); down.className='btn-icon'; down.innerHTML='â†“';
            down.onclick = () => swap(i, i+1);
            actions.appendChild(down);
        }
        
        const del = document.createElement('button'); del.className='btn-icon'; del.innerHTML='âœ•';
        del.onclick = () => removeStop(i);
        if(state.colors.length <= 2) del.disabled = true;
        
        actions.appendChild(del);
        
        row.appendChild(prev);
        row.appendChild(text);
        row.appendChild(actions);
        DOM.colorList.appendChild(row);
      });
    }

    function updateStop(idx, val){ 
      state.colors[idx] = normHex(val); 
      refresh();
      saveUserPreferences(); // Save when colors change
    }
    
    function removeStop(idx){ 
      if(state.colors.length>2) { 
        state.colors.splice(idx,1); 
        refresh(); 
        saveUserPreferences(); // Save when colors change
      } else {
        showToast(state.language === 'ar' ? "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„ÙˆÙ†ÙŠÙ† Ù…Ø·Ù„ÙˆØ¨" : "Minimum 2 colors required"); 
      }
    }
    
    function swap(i,j){ 
      [state.colors[i],state.colors[j]] = [state.colors[j],state.colors[i]]; 
      refresh(); 
      saveUserPreferences(); // Save when colors change
    }

    function refresh(){
      renderStops();
      
      // Update config inputs
      DOM.stepsVal.textContent = state.steps;
      DOM.stepsSlider.value = state.steps;

      // Generate
      state.generated = interpolate(state.colors, state.steps, state.vivid?'lab':'linear');
      
      // Visuals - Update preview box with strips
      const css = getGradientCSS();
      DOM.cssText.textContent = css.length > 50 ? css.substring(0,47)+'...' : css;
      
      // Update preview box with strips
      DOM.preview.innerHTML = '';
      state.generated.forEach(c => {
        const strip = document.createElement('div'); 
        strip.className = 'preview-strip';
        strip.style.backgroundColor = c;
        strip.setAttribute('data-color', c);
        strip.title = c;
        strip.onclick = () => copy(c);
        DOM.preview.appendChild(strip);
      });
      
      // Strip
      DOM.strip.innerHTML = '';
      state.generated.forEach(c => {
        const d = document.createElement('div'); d.className='step-unit'; d.style.backgroundColor=c; d.title=c;
        d.onclick = () => copy(c);
        DOM.strip.appendChild(d);
      });
    }

    function getGradientCSS(){
       const stops = state.generated.join(', ');
       return `linear-gradient(to right, ${stops})`;
    }

    /* ---------- Actions ---------- */
    function copy(txt){
      navigator.clipboard.writeText(txt).then(() => showToast(state.language === 'ar' ? "ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©" : "Copied to clipboard"));
    }
    
    function showToast(msg){
      DOM.toast.textContent = msg;
      DOM.toast.classList.add('show');
      setTimeout(()=>DOM.toast.classList.remove('show'), 2000);
    }

    /* ---------- Export ---------- */
    function downloadCSS() {
      const cssContent = `.lumina-gradient {\n  background: ${getGradientCSS()};\n}\n\n/* Generated by Lumina Studio */`;
      const blob = new Blob([cssContent], { type: 'text/css' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.download = 'lumina-gradient.css';
      link.href = url;
      link.click();
      URL.revokeObjectURL(url);
      showToast(state.language === 'ar' ? 'ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù CSS' : 'CSS file downloaded');
    }
    
    function downloadPNG(){
      // Create canvas with strips instead of gradient
      const w = 800, h = 400;
      const stripWidth = w / state.generated.length;
      
      DOM.canvas.width = w;
      DOM.canvas.height = h;
      const ctx = DOM.canvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;
      
      // Draw each strip
      state.generated.forEach((color, i) => {
        ctx.fillStyle = color;
        ctx.fillRect(i * stripWidth, 0, stripWidth + 1, h); // +1 to avoid gaps
      });
      
      // Create download link
      const link = document.createElement('a');
      link.download = 'lumina-gradient.png';
      link.href = DOM.canvas.toDataURL('image/png', 0.9);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast(state.language === 'ar' ? 'ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù PNG' : 'PNG file downloaded');
    }

    /* ---------- Modal Management ---------- */
    function toggleModal(id, show) {
        const el = document.getElementById(id);
        if(show) { 
          el.classList.add('active'); 
          DOM.body.classList.add('modal-open');
          if (id === 'presetsModal') {
            renderPresets();
            renderUserGradients();
          }
        } else { 
          el.classList.remove('active'); 
          DOM.body.classList.remove('modal-open');
        }
    }

    /* ---------- Init Event Listeners ---------- */
    
    function updateBaseColorPreview() {
      const color = DOM.genBase.value;
      DOM.baseColorPreview.style.backgroundColor = color;
      DOM.genHex.value = color.toUpperCase();
    }
    
    // Language Toggle
    DOM.langToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      DOM.langDropdown.classList.toggle('show');
    });
    
    DOM.langOptions.forEach(option => {
      option.addEventListener('click', () => {
        const lang = option.dataset.lang;
        setLanguage(lang);
        DOM.langDropdown.classList.remove('show');
      });
    });
    
    document.addEventListener('click', () => {
      DOM.langDropdown.classList.remove('show');
    });

    // Auth Events
    DOM.userAccountBtn.addEventListener('click', () => {
      toggleModal('authModal', true);
      updateUserUI();
    });
    
    DOM.signInBtn.addEventListener('click', () => {
      const email = DOM.signInEmail.value;
      const password = DOM.signInPassword.value;
      
      if (!email || !password) {
        DOM.authError.textContent = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†';
        DOM.authError.classList.add('show');
        return;
      }
      
      signIn(email, password);
    });
    
    DOM.signUpBtn.addEventListener('click', () => {
      const name = DOM.signUpName.value;
      const email = DOM.signUpEmail.value;
      const password = DOM.signUpPassword.value;
      const confirmPassword = DOM.signUpConfirmPassword.value;
      signUp(name, email, password, confirmPassword);
    });
    
    DOM.googleSignInBtn.addEventListener('click', signInWithGoogle);
    DOM.googleSignUpBtn.addEventListener('click', signInWithGoogle);
    
    DOM.switchToSignUp.addEventListener('click', (e) => {
      e.preventDefault();
      toggleAuthForm(true);
    });
    
    DOM.switchToSignIn.addEventListener('click', (e) => {
      e.preventDefault();
      toggleAuthForm(false);
    });
    
    DOM.updateProfileBtn.addEventListener('click', updateProfile);
    
    DOM.signOutBtn.addEventListener('click', signOut);
    
    document.querySelectorAll('.close-auth-modal, #authModal').forEach(el => {
      el.addEventListener('click', (e) => {
        if (el === e.target || el.classList.contains('close-auth-modal')) {
          toggleModal('authModal', false);
        }
      });
    });

    // Generator - Generate New Harmony (different each time)
    DOM.genBase.addEventListener('input', (e) => {
      updateBaseColorPreview();
      DOM.genHex.value = e.target.value.toUpperCase();
    });
    
    DOM.genHex.addEventListener('change', (e) => {
      const color = normHex(e.target.value);
      DOM.genBase.value = color;
      DOM.baseColorPreview.style.backgroundColor = color;
      DOM.genHex.value = color;
    });
    
    DOM.btnGen.addEventListener('click', () => {
       // Generate new harmonious colors based on the current base color
       const baseColor = DOM.genBase.value;
       state.colors = generateNewHarmoniousColors(baseColor);
       refresh();
       saveUserPreferences(); // Save when colors change
       showToast(getMessage('paletteGenerated'));
    });

    // Editor
    DOM.btnAdd.addEventListener('click', () => { 
      if(state.colors.length < 10) { 
        // Add a harmonious color when adding new stop
        const baseColor = state.colors[0] || DOM.genBase.value;
        const newColors = generateNewHarmoniousColors(baseColor);
        if (newColors.length > 1) {
          state.colors.push(newColors[1]); 
          refresh(); 
          saveUserPreferences(); // Save when colors change
          showToast(state.language === 'ar' ? "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ù…ØªÙ†Ø§Ø³Ù‚" : "Harmonious color added");
        }
      } else {
        showToast(state.language === 'ar' ? "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ 10 Ø£Ù„ÙˆØ§Ù†" : "Maximum 10 colors allowed");
      }
    });
    
    DOM.btnRandom.addEventListener('click', () => {
      const count = Math.floor(Math.random() * 4) + 2;
      state.colors = generateRandomColors(count);
      refresh();
      saveUserPreferences(); // Save when colors change
      showToast(state.language === 'ar' ? `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${count} Ø£Ù„ÙˆØ§Ù† Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©` : `Generated ${count} random colors`);
    });
    
    DOM.stepsSlider.addEventListener('input', e => { 
      state.steps = parseInt(e.target.value); 
      refresh(); 
      saveUserPreferences(); // Save when steps change
    });
    
    DOM.stepsDecrease.addEventListener('click', () => {
      if (state.steps > 2) {
        state.steps--;
        DOM.stepsSlider.value = state.steps;
        refresh();
        saveUserPreferences(); // Save when steps change
      }
    });
    
    DOM.stepsIncrease.addEventListener('click', () => {
      if (state.steps < 100) {
        state.steps++;
        DOM.stepsSlider.value = state.steps;
        refresh();
        saveUserPreferences(); // Save when steps change
      }
    });
    
    DOM.vividFlag.addEventListener('change', e => { 
      state.vivid = e.target.checked; 
      refresh(); 
      saveUserPreferences(); // Save when vivid mode changes
    });

    // User Gradients
    DOM.saveGradientBtn.addEventListener('click', saveCurrentGradient);
    DOM.clearSavedGradients.addEventListener('click', clearSavedGradients);

    // Modals
    DOM.presetsBtn.addEventListener('click', () => toggleModal('presetsModal', true));
    DOM.breakdownBtn.addEventListener('click', () => {
        DOM.breakGrid.innerHTML = '';
        state.generated.forEach(c => {
            const b = document.createElement('div'); 
            b.style.height='40px'; 
            b.style.background=c; 
            b.style.borderRadius='4px'; 
            b.style.cursor='pointer';
            b.title = c;
            b.onclick = () => copy(c);
            DOM.breakGrid.appendChild(b);
        });
        toggleModal('breakdownModal', true);
    });

    document.querySelectorAll('.close-modal, .close-breakdown, .modal-overlay').forEach(el => {
       el.addEventListener('click', (e) => {
          if(el === e.target || el.classList.contains('close-modal') || el.classList.contains('close-breakdown')) {
             document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
             DOM.body.classList.remove('modal-open');
          }
       });
    });

    // Render Presets
    function renderPresets(){
        DOM.presetsGrid.innerHTML = '';
        PRESETS.forEach(p => {
           const card = document.createElement('div'); 
           card.className = 'preset-item';
           
           const prev = document.createElement('div'); 
           prev.className='preset-preview';
           
           const gradientColors = interpolate(p.colors, 10, 'linear');
           
           gradientColors.forEach(c => {
             const strip = document.createElement('div');
             strip.className = 'preset-strip';
             strip.style.backgroundColor = c;
             prev.appendChild(strip);
           });
           
           const info = document.createElement('div'); 
           info.className='preset-info'; 
           info.textContent = p.name;
           
           card.appendChild(prev); 
           card.appendChild(info);
           card.onclick = () => {
               state.colors = [...p.colors];
               refresh();
               saveUserPreferences(); // Save when colors change
               toggleModal('presetsModal', false);
               showToast(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ${p.name}`);
           };
           DOM.presetsGrid.appendChild(card);
        });
    }

    // Export Menu
    DOM.exportToggle.addEventListener('click', e => { e.stopPropagation(); DOM.exportMenu.classList.toggle('show'); });
    document.addEventListener('click', () => DOM.exportMenu.classList.remove('show'));
    
    DOM.actions.css.onclick = () => copy(getGradientCSS());
    DOM.actions.tw.onclick = () => copy(`bg-gradient-to-r from-[${state.colors[0]}] to-[${state.colors[state.colors.length-1]}]`);
    DOM.actions.dlCss.onclick = downloadCSS;
    DOM.actions.dlPng.onclick = downloadPNG;
    DOM.cssTrigger.onclick = () => copy(getGradientCSS());

    // Theme
    DOM.themeToggle.addEventListener('click', () => {
        state.theme = state.theme==='dark'?'light':'dark';
        document.body.setAttribute('data-theme', state.theme);
        saveUserPreferences(); // Save when theme changes
    });

    // Start
    // Set Arabic as default language
    setLanguage('ar');
    
    // Initialize Firebase auth state listener
    if (state.firebaseAvailable) {
      AuthService.onAuthStateChanged((user) => {
        if (user) {
          state.user = user;
          localStorage.setItem('luminaUser', JSON.stringify(user));
        } else {
          state.user = null;
          localStorage.removeItem('luminaUser');
        }
        updateUserUI();
        loadUserData();
      });
    } else {
      // Fallback: Load user from localStorage if Firebase is not available
      if (state.user) {
        updateUserUI();
      }
      loadUserData();
    }
    
    refresh();
    updateBaseColorPreview();
    renderUserGradients();

    // Add Firebase configuration instructions
    setTimeout(() => {
      if (!state.firebaseAvailable || firebaseConfig.apiKey.includes("AIzaSyBwYV7Xq3pG5K4Hj3vZ8q9LmNtRwS2uYzX")) {
        console.warn(`
        âš ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ØºÙŠØ± Ù…Ù‡ÙŠØ¦Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!
        
        Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠØ±Ø¬Ù‰ Ø§ØªØ¨Ø§Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:
        
        1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰: https://console.firebase.google.com
        2. Ø£Ù†Ø´Ø¦ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
        3. Ø£Ø¶Ù ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ (Web App)
        4. Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø§Ø®ØªØ± âš™ â†’ Project settings
        5. Ø§Ø¨Ø­Ø« Ø¹Ù† "SDK setup and configuration"
        6. Ø§Ø®ØªØ± "Config" ÙˆØ§Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ†
        7. Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨ÙŠØ§Ù†Ø§Øª firebaseConfig ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ
        
        Ù…Ø«Ø§Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬Ù‡Ø§:
        const firebaseConfig = {
          apiKey: "Ù…ÙØªØ§Ø­-API-Ø§Ù„Ø®Ø§Øµ-Ø¨Ùƒ",
          authDomain: "Ø§Ø³Ù…-Ù…Ø´Ø±ÙˆØ¹Ùƒ.firebaseapp.com",
          projectId: "Ø§Ø³Ù…-Ù…Ø´Ø±ÙˆØ¹Ùƒ",
          storageBucket: "Ø§Ø³Ù…-Ù…Ø´Ø±ÙˆØ¹Ùƒ.appspot.com",
          messagingSenderId: "Ø±Ù‚Ù…-Ø§Ù„Ù…Ø±Ø³Ù„",
          appId: "1:Ø±Ù‚Ù…:ÙˆÙŠØ¨:Ù…Ø¹Ø±Ù-Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"
        };
        `);
        
        // Show a friendly warning to the user
        if (!localStorage.getItem('firebaseWarningShown')) {
          showToast('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªÙƒÙˆÙŠÙ† Firebase Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ');
          localStorage.setItem('firebaseWarningShown', 'true');
        }
      }
    }, 3000);

  </script>
</body>
</html>
